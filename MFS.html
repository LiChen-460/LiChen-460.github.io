<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>ä¸»é¡Œåœ°åœ– - æ”¶è—é»äº’å‹•ç¯„ä¾‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%; height: 100%; position: absolute;
    }
    /*å³é‚Šè³‡è¨Šæ¡†è¦–è¦ºæ•ˆæœè¨­å®š*/
    #info-box {
      position: absolute;
      top: 10px; right: 10px;
      width: 300px; height: calc(100vh - 20px);
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      padding: 20px;
      box-sizing: border-box;
      transform: translateX(110%);
      transition: transform 0.3s ease;
      overflow: hidden;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    /*å³é‚Šè³‡è¨Šæ¡†çš„æ»‘å‹•å‹•ç•«*/
    #info-box.active {
      transform: translateX(0);
    }
    #info-content {
      overflow-y: auto;
      flex: 1;
      padding-right: 6px;
    }

    #info-content::-webkit-scrollbar {
      width: 0px; /* æ²è»¸å¯¬åº¦ */
      margin-right: 0px; /* */
    }

    #info-content h2 {
      font-size: 18px; margin-top: 0;
    }
    #info-content p {
      font-size: 14px; margin-bottom: 10px;
    }
    #info-content img {
      max-width: 100%; border-radius: 8px; margin-top: 10px;
    }
    /*å³é‚Šè³‡è¨Šæ¡†çš„é—œé–‰æŒ‰éˆ•*/
    #close-btn {
      position: absolute;
      top: 10px; right: 10px;
      background: #eee; border: none;
      border-radius: 50%; width: 24px; height: 24px;
      text-align: center; cursor: pointer;
      font-weight: bold; z-index: 1001;
    }

    /* å·¦ä¸‹è§’è¨ªå®¢æˆ–ä½¿ç”¨è€…è³‡è¨ŠæŒ‰éˆ• */
    #user-status-btn {
      position: absolute;
      bottom: 10px; left: 10px;
      background-color: #fff;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      z-index: 1000;
      user-select: none;
    }

    /* ä½¿ç”¨è€…å¡ç‰‡å¤–æ®¼ */
    #user-box-wrapper {
      position: absolute;
      bottom: 10px; left: 10px;
      width: 300px; max-height: 320px;
      overflow: hidden;
      z-index: 1001;
      pointer-events: none;
      transition: transform 0.3s ease;
      transform: translateY(110%);
      box-sizing: border-box;
    }

    /*å‹•ç•«*/
    #user-box-wrapper.active {
      pointer-events: auto;
      transform: translateY(0);
    }

    /* ä½¿ç”¨è€…å¡ç‰‡æœ¬é«” */
    #user-box {
      width: 100%; height: 100%;
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      padding: 10px 20px 20px 20px;  /* ä¸Šæ–¹å…§è·è®Šå°è®“æ–‡å­—å¾€ä¸Š */
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      max-height: 320px;
      position: relative;
    }

    #user-box::-webkit-scrollbar {
      width: 0px; /* æ²è»¸å¯¬åº¦ */
      margin-right: 0px; /* */
    }

    /* å·¦é‚Šé—œé–‰éµï¼Œè·Ÿå³é‚Šä¸€æ¨£æ¨£å¼ */
    #user-close-btn {
      position: absolute;
      top: 10px; right: 10px;
      background: #eee;
      border: none;
      border-radius: 50%;
      width: 24px; height: 24px;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
      line-height: 24px;
      font-size: 18px;
      padding: 0;
      z-index: 1002;
    }

    #user-box-header {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
    }

    /* æ”¶è—åœ°é»åˆ—è¡¨é¢¨æ ¼ */
    #fav-list {
      padding: 0;
      margin: 0;
      list-style: none;
    }

    #fav-list button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      padding: 8px 12px;
      margin: 4px 0;
      color: #555;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      border-radius: 8px;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-family: inherit;
    }

    #fav-list button:hover {
      background-color: #e6f0ff;
      color: #224488;
    }

    .tab {
      padding: 6px 12px;
      background-color: #f0f0f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .tab.active {
      background-color: #224488;
      color: white;
    }

    .tab-button.active {
      font-weight: bold;
      background: #f0f0f0 !important;
    }




  </style>
</head>
<body>
  <div id="map"></div>

  <div id="info-box">
    <button id="close-btn">Ã—</button>
    <div id="info-content"></div>
  </div>

  <!-- å·¦ä¸‹è§’ç™»å…¥ç‹€æ…‹æŒ‰éˆ• -->
  <div id="user-status-btn">è¨ªå®¢</div>

  <!-- å·¦ä¸‹è§’ä½¿ç”¨è€…è³‡è¨Šå¡ç‰‡ -->
  <div id="user-box-wrapper">
    <div id="user-box">
      <button id="user-close-btn">Ã—</button>
      <div id="user-box-header">ä½¿ç”¨è€…è³‡è¨Š</div>
      <div id="user-box-content"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>


    // é™åˆ¶åœ°åœ–èƒ½çœ‹åˆ°çš„é‚Šç•Œ
    const worldBounds = L.latLngBounds(
      L.latLng(-85.0511, -Infinity),
      L.latLng(85.0511, Infinity)
    );



    //åœ°åœ–è¨­å®š
    const map = L.map('map', {
      center: [25.0330, 121.5654], //åˆå§‹åœ°åœ–ä¸­å¿ƒ
      zoom: 13,  //åˆå§‹ç¸®æ”¾å¤§å°
      minZoom: 1.2,  //æœ€å°å¯ä»¥ç¸®åˆ°å¤šå°‘çš„é™åˆ¶
      worldCopyJump: true,  //å·¦å³ç„¡é‚Šéš›åœ°åœ–
      maxBounds: worldBounds,  //é™åˆ¶åœ°åœ–çš„é‚Šç•Œ
      maxBoundsViscosity: 0.8  //åœ¨åœ°åœ–é‚Šé‚Šæ‹‰ä¸€ä¸‹æœƒæœ‰å›å½ˆæ•ˆæœ
    });
    

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors' ,
    }).addTo(map);


    map.on('moveend', () => {
    if (!worldBounds.contains(map.getCenter())) {
        map.panInsideBounds(worldBounds, { animate: true }); //é™åˆ¶åœ°åœ–ä¸èƒ½æ‹‰è¶…éé‚Šç•Œ
      }
    });



    const markersMap = {};
    const infoBox = document.getElementById("info-box");
    const infoContent = document.getElementById("info-content");
    const closeBtn = document.getElementById("close-btn");

    /*
    const locations = [
      {
        name: "å°åŒ—101",
        lat: 25.0330,
        lng: 121.5654,
        description: "å°ç£æœ€çŸ¥åçš„åœ°æ¨™èˆ‡è§€æ™¯å°ã€‚<br/><br/>é€™è£¡æœ‰æ›´å¤šæè¿°å…§å®¹æœƒè®“ä½ çœ‹åˆ°æ»¾å‹•æ•ˆæœï¼šLorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus.sum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussum dolor sit amet, consectetur adipiscing elit. Sed non risussectetur adipiscing elit. Sed non risus Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor.",
        image: "pic1.png"
      },
      {
        name: "ä¸­æ­£ç´€å¿µå ‚",
        lat: 25.0345,
        lng: 121.5215,
        description: "æ­·å²æ–‡åŒ–å ´é¤¨ï¼Œç´€å¿µè”£ä¸­æ­£ç¸½çµ±ã€‚",
        image: "pic2.jpg"
      }
    ];*/
  
  // å–å¾—è³‡æ–™ & åŠ å…¥åœ°åœ–
  fetch("http://localhost:5000/api/locations")
    .then(response => response.json())
    .then(data => {
      data.forEach(loc => {
        for (let i = -2; i <= 2; i++) {
        const offsetLng = parseFloat(loc.MEME_LONGITUDE) + i * 360;
        const marker = L.marker([parseFloat(loc.MEME_LATITUDE), offsetLng]).addTo(map);
        marker.on("click", () => {
          map.flyTo(marker.getLatLng(), 13, {animate: true,duration: 1});
          showInfo({
            name: loc.MEME_NAME,
            image: loc.MEME_IMAGE,
            country: loc.MEME_COUNTRY,
            area: loc.MEME_AREA,
            link: loc.MEME_LINK,
            description: loc.MEME_DESCRIPTION,
            lat: loc.MEME_LATITUDE,
            lng: loc.MEME_LONGITUDE
          });
        });
        if (i === 0) markersMap[loc.MEME_NAME] = marker;
      }
      });
    })
    .catch(error => {
      console.error("æŠ“å–åœ°åœ–è³‡æ–™å¤±æ•—ï¼š", error);
    });


    function showInfo(loc) {
      const isFavorite = favoritePlaces.includes(loc.name);
      const favBtnText = isFavorite ? "â˜… å·²æ”¶è—" : "â˜† æ”¶è—";
      
      infoContent.innerHTML = `
        <img src="${loc.image}" alt="${loc.name}" />
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
          <h2 style="margin: 0;">${loc.name}</h2>
          <button id="fav-btn" style="font-size: 16px; background: none; border: none; cursor: pointer;">${favBtnText}</button>
        </div>

        <div style="margin-top: 15px;">
          <div style="display: flex; border-bottom: 1px solid #ccc;">
            <button id="tab-intro" class="tab-button active" style="flex: 1; padding: 10px; border: none; background: #f0f0f0; cursor: pointer;">ä»‹ç´¹</button>
            <button id="tab-comment" class="tab-button" style="flex: 1; padding: 10px; border: none; background: #fff; cursor: pointer;">è©•è«–</button>
          </div>
          <div id="tab-content" style="padding: 10px; font-size: 14px;">
            ${loc.description}
          </div>
        </div>
      `;

  // åŠ å…¥ tab åˆ‡æ›é‚è¼¯
  const tabIntro = document.getElementById("tab-intro");
  const tabComment = document.getElementById("tab-comment");
  const tabContent = document.getElementById("tab-content");

  tabIntro.addEventListener("click", () => {
    tabIntro.classList.add("active");
    tabComment.classList.remove("active");
    tabIntro.style.background = "#f0f0f0";
    tabComment.style.background = "#fff";
    tabContent.innerHTML = loc.description;
  });

  tabComment.addEventListener("click", () => {
    tabIntro.classList.remove("active");
    tabComment.classList.add("active");
    tabIntro.style.background = "#fff";
    tabComment.style.background = "#f0f0f0";
    tabContent.innerHTML = "ï¼ˆå°šç„¡è©•è«–ï¼‰";
  });

  // æ”¶è—æŒ‰éˆ•è™•ç†
  const favBtn = document.getElementById("fav-btn");
  favBtn.addEventListener("click", () => {
    if (!isLoggedIn) {
      alert("è«‹å…ˆç™»å…¥æ‰èƒ½æ”¶è—åœ°é»ï¼");
      return;
    }

    if (favoritePlaces.includes(loc.name)) {
      favoritePlaces = favoritePlaces.filter(name => name !== loc.name);
      favBtn.textContent = "â˜† æ”¶è—";
    } else {
      favoritePlaces.push(loc.name);
      favBtn.textContent = "â˜… å·²æ”¶è—";
    }

    updateUserBoxContent();
  });

  infoBox.classList.add("active");
}


    closeBtn.addEventListener("click", () => {
      infoBox.classList.remove("active");
    });

    // ç™»å…¥æ¨¡æ“¬
    let isLoggedIn = false;
    let userName = "è¨ªå®¢";
    let favoritePlaces = [];

    const userStatusBtn = document.getElementById("user-status-btn");
    const userBoxWrapper = document.getElementById("user-box-wrapper");
    const userBoxHeader = document.getElementById("user-box-header");
    const userBoxContent = document.getElementById("user-box-content");
    const userCloseBtn = document.getElementById("user-close-btn");

    function updateUserBoxContent() {
      userBoxHeader.textContent = isLoggedIn ? `ğŸ‘¤ ${userName}` : "è«‹å…ˆç™»å…¥";
      if (isLoggedIn) {
        userBoxContent.innerHTML = `
          <p>æ­¡è¿å›ä¾†ï¼Œ${userName}ï¼</p>
          <p>ä½ çš„æ”¶è—åœ°é»ï¼š</p>
          <ul id="fav-list">
            ${favoritePlaces.map(place => `<li><button type="button">${place}</button></li>`).join("")}
          </ul>
        `;
        setTimeout(() => {
          const favButtons = document.querySelectorAll('#fav-list button');
          favButtons.forEach(btn => {
            btn.addEventListener('click', () => {
              const placeName = btn.textContent;
              const marker = markersMap[placeName];
              if (marker) {
                map.flyTo(marker.getLatLng(), 13, {animate: true,duration: 1});
                const loc = locations.find(l => l.name === placeName);
                if (loc) {
                  showInfo(loc);
                }
              } else {
                alert("æ‰¾ä¸åˆ°æ­¤åœ°é»çš„å¤§é ­é‡");
              }
            });
          });
        }, 0);
      } else {
        userBoxContent.innerHTML = `
          <p>è«‹å…ˆç™»å…¥ä»¥æª¢è¦–æ”¶è—åœ°é»</p>
          <button id="login-btn">ç™»å…¥</button>
        `;
        setTimeout(() => {
          const loginBtn = document.getElementById("login-btn");
          loginBtn.addEventListener("click", () => {
            isLoggedIn = true;
            userName = "é˜¿èŠ±";
            userStatusBtn.textContent = userName;
            updateUserBoxContent();
            userBoxWrapper.classList.add("active");
          });
        }, 0);
      }
    }

    userStatusBtn.addEventListener("click", () => {
      userBoxWrapper.classList.toggle("active");
      if (!isLoggedIn) {
        userBoxWrapper.classList.add("active");
      }
    });
    userCloseBtn.addEventListener("click", () => {
      userBoxWrapper.classList.remove("active");
    });

    updateUserBoxContent();

  </script>
</body>
</html>
